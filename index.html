<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Loja - Afiliados Amazon</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
/* Cards */
.product-card {
  transition: transform .2s ease, box-shadow .2s ease;
}
.product-card:hover {
  transform: translateY(-8px) scale(1.03);
  box-shadow: 0 12px 32px rgba(0,0,0,.15);
}
/* Carrossel */
#carouselContainer { position: relative; overflow: hidden; margin-bottom:2rem; }
#carouselTrack { display: flex; gap: 1rem; transition: transform 0.3s ease; }
.carousel-item { flex: 0 0 280px; }
#carouselPrev, #carouselNext {
  position: absolute; top: 50%; transform: translateY(-50%);
  background: rgba(0,0,0,0.5); color:white; border:none; padding:0.5rem;
  cursor:pointer; border-radius:50%; font-size:1.5rem;
}
#carouselPrev { left: 0.5rem; }
#carouselNext { right: 0.5rem; }
</style>
</head>
<body class="bg-gray-50 text-gray-800">

<header class="bg-white shadow-md">
  <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row items-center justify-between gap-4">
    <h1 class="text-2xl font-bold text-yellow-600">Loja de Afiliados Amazon</h1>
    <div class="flex flex-wrap items-center gap-2">
      <input id="search" placeholder="Pesquisar produtos..." class="px-3 py-2 border rounded-md" />
      <select id="categoryFilter" class="px-3 py-2 border rounded-md">
        <option value="">Todas as categorias</option>
      </select>
      <select id="sortSelect" class="px-3 py-2 border rounded-md">
        <option value="relevance">Mais relevantes</option>
        <option value="price_asc">Preço ↑</option>
        <option value="price_desc">Preço ↓</option>
        <option value="promo_desc">Desconto ↓</option>
      </select>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-8">

  <!-- Carrossel -->
  <section>
    <h2 class="text-xl font-semibold mb-4">Produtos em destaque</h2>
    <div id="carouselContainer">
      <button id="carouselPrev">‹</button>
      <div id="carouselTrack"></div>
      <button id="carouselNext">›</button>
    </div>
  </section>

  <!-- Estatísticas e grid -->
  <section id="stats" class="mb-6 text-sm text-gray-600"></section>
  <section id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></section>
  <nav id="pagination" class="mt-8 flex justify-center"></nav>

</main>

<footer class="text-center text-sm text-gray-500 py-6">Gerado com ❤️ — Template de catálogo usando Google Sheets</footer>

<script>
const WEBAPP_URL='https://script.google.com/macros/s/AKfycbzX7nYrpzC9QEXk-rMxzu6WTPG0Ox9tKj33v-mwWI6vC0gxcXki7k_uhs7dc4LvdCrs6Q/exec';
const PAGE_SIZE=24;
let PRODUCTS=[], currentPage=1;

function toNumber(v){ if(!v) return null; return parseFloat(String(v).replace(',','.')); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

function renderCard(p){
  const price = p.price!=null?`€${p.price.toFixed(2)}`:'—';
  const promo = (p.promo_price!=null && p.promo_price<p.price)?`€${p.promo_price.toFixed(2)}`:null;
  const discount = (p.promo_price!=null && p.promo_price<p.price)?Math.round((1-p.promo_price/p.price)*100):0;
  const img = p.image || 'https://via.placeholder.com/400x300?text=Sem+imagem';
  const link = p.affiliate_link || '#';
  return `
  <article class="bg-white rounded-2xl p-4 product-card relative">
    ${promo?`<div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-md text-xs font-bold">-${discount}%</div>`:''}
    <img loading="lazy" src="${img}" alt="${escapeHtml(p.title)}" class="w-full h-48 object-cover rounded-lg mb-3"/>
    <h3 class="text-sm font-semibold mb-2">${escapeHtml(p.title)}</h3>
    <div class="flex justify-between items-center">
      <div>${promo?`<div class="text-sm text-gray-500 line-through">${price}</div><div class="text-lg font-bold">${promo}</div>`:`<div class="text-lg font-bold">${price}</div>`}</div>
      <a href="${link}" target="_blank" rel="noopener noreferrer" class="px-3 py-2 bg-yellow-500 hover:bg-yellow-600 transition rounded-md text-sm font-semibold">Ver oferta</a>
    </div>
  </article>`;
}

function renderGrid(list){ document.getElementById('grid').innerHTML=list.map(renderCard).join(''); }
function renderStats(total){ document.getElementById('stats').textContent=`Produtos encontrados: ${total}`; }

function renderPagination(totalItems){
  const pages=Math.max(1,Math.ceil(totalItems/PAGE_SIZE));
  const nav=document.getElementById('pagination'); let html='';
  const start=Math.max(1,currentPage-2), end=Math.min(pages,currentPage+2);
  if(currentPage>1) html+=`<button onclick="gotoPage(${currentPage-1})" class="px-3 py-1 mx-1 bg-white border rounded">«</button>`;
  for(let i=start;i<=end;i++) html+=`<button onclick="gotoPage(${i})" class="px-3 py-1 mx-1 ${i===currentPage?'bg-yellow-400 text-white rounded':'bg-white border rounded'}">${i}</button>`;
  if(currentPage<pages) html+=`<button onclick="gotoPage(${currentPage+1})" class="px-3 py-1 mx-1 bg-white border rounded">»</button>`;
  nav.innerHTML=html;
}
function gotoPage(n){ currentPage=n; applyFiltersAndRender(); }

function applyFiltersAndRender(){
  const q=document.getElementById('search').value.trim().toLowerCase();
  const cat=document.getElementById('categoryFilter').value;
  let filtered=PRODUCTS.filter(p=>{
    const inCat=!cat||(p.category&&p.category.toLowerCase()===cat.toLowerCase());
    const inQ=!q||(p.title&&p.title.toLowerCase().includes(q));
    return inCat && inQ;
  });
  renderStats(filtered.length);
  renderPagination(filtered.length);
  const start=(currentPage-1)*PAGE_SIZE;
  renderGrid(filtered.slice(start,start+PAGE_SIZE));
  renderCarousel(filtered.slice(0,10));
}

// Carrossel
function renderCarousel(items){
  const track=document.getElementById('carouselTrack');
  track.innerHTML=items.map(p=>`<div class="carousel-item">${renderCard(p)}</div>`).join('');
}
document.getElementById('carouselPrev').addEventListener('click',()=>{document.getElementById('carouselTrack').scrollBy({left:-300,behavior:'smooth'});});
document.getElementById('carouselNext').addEventListener('click',()=>{document.getElementById('carouselTrack').scrollBy({left:300,behavior:'smooth'});});

// Carregar dados
async function loadData(){
  try{
    const res=await fetch(WEBAPP_URL);
    const data=await res.json();
    PRODUCTS=data.map(p=>({
      title:p.título||'Sem título',
      image:p.imagem||'',
      price:toNumber(p.preço),
      promo_price:toNumber(p.promoção),
      affiliate_link:p.link||'#',
      category:p.categoria||''
    }));
    populateCategories(); applyFiltersAndRender();
  }catch(e){console.error(e); alert('Erro ao carregar os produtos. Verifica o Web App e a Sheet.');}
}

function populateCategories(){
  const set=new Set();
  PRODUCTS.forEach(p=>{if(p.category)set.add(p.category.trim());});
  const sel=document.getElementById('categoryFilter');
  set.forEach(c=>{const opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);});
}

document.getElementById('search').addEventListener('input',()=>{currentPage=1; applyFiltersAndRender();});
document.getElementById('categoryFilter').addEventListener('change',()=>{currentPage=1; applyFiltersAndRender();});
document.getElementById('sortSelect').addEventListener('change',()=>{currentPage=1; applyFiltersAndRender();});

loadData();
</script>
</body>
</html>
